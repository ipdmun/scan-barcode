<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>입고 스캐너</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1em;
      text-align: center;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin: auto;
    }
    #result {
      margin-top: 1em;
      font-size: 1.2em;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h2>📦 입고 바코드 스캐너</h2>
  <div id="reader"></div>
  <div id="result">스캔하면 입고정보를 읽어줍니다</div>

  <script>
    let lastScanned = "";
    let scanCount = 0;

    function speak(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'ko-KR';
      speechSynthesis.cancel();
      speechSynthesis.speak(msg);
    }

    function handleScannedBarcode(barcode) {
      if (barcode !== lastScanned) {
        lastScanned = barcode;
        scanCount = 0;
      }

      if (scanCount >= 2) return;
      scanCount++;

      fetch(`https://script.google.com/macros/s/AKfycbzkMBIZkxl6jTMugWYUxDiiz9MP-L7RikCpNnnkjOeZ166jbTZhxdNgOPsLoeG7-jOT/exec?barcode=${barcode}`)
        .then((res) => res.json())
        .then((data) => {
          const resultDiv = document.getElementById("result");

          if (data.found && data.matches.length > 0) {
            let text = `✅ SKU명: ${data.sku}\n`;
            text += data.matches.map(match =>
              `📍 ${match.center} 센터\n📅 입고 예정일: ${match.date}\n📦 납품수량: ${match.qty}개\n`
            ).join("\n");

            resultDiv.innerText = text;

            // 첫 번째 항목만 음성으로 안내
            const first = data.matches[0];
            speak(`${first.center} 센터, 입고 예정일 ${first.date}, 납품수량 ${first.qty}개, 상품: ${data.sku}`);
          } else {
            resultDiv.innerText = "❌ 바코드 없음";
            speak("해당 바코드를 찾을 수 없습니다");
          }
        })
        .catch((err) => {
          document.getElementById("result").innerText = "❌ 요청 오류";
          speak("요청 중 오류가 발생했습니다");
        });
    }

    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            handleScannedBarcode(decodedText);
          },
          (errorMessage) => {
            // 에러 무시
          }
        );
      }
    }).catch(err => {
      document.getElementById("result").innerText = "📷 카메라 접근 실패";
    });
  </script>
</body>
</html>
