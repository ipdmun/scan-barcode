<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì…ê³  ìŠ¤ìºë„ˆ</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1em;
      text-align: center;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin: auto;
    }
    #result {
      margin-top: 1em;
      font-size: 1.2em;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h2>ğŸ“¦ ì…ê³  ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</h2>
  <div id="reader"></div>
  <div id="result">ìŠ¤ìº”í•˜ë©´ ì…ê³ ì •ë³´ë¥¼ ì½ì–´ì¤ë‹ˆë‹¤</div>

  <script>
    let lastScanned = "";
    let scanCount = 0;

    function speak(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'ko-KR';
      speechSynthesis.cancel();
      speechSynthesis.speak(msg);
    }

    function handleScannedBarcode(barcode) {
      if (barcode !== lastScanned) {
        lastScanned = barcode;
        scanCount = 0;
      }

      if (scanCount >= 2) return;
      scanCount++;

      fetch(`https://script.google.com/macros/s/AKfycbzkMBIZkxl6jTMugWYUxDiiz9MP-L7RikCpNnnkjOeZ166jbTZhxdNgOPsLoeG7-jOT/exec?barcode=${barcode}`)
        .then((res) => res.json())
        .then((data) => {
          const resultDiv = document.getElementById("result");

          if (data.found && data.matches.length > 0) {
            let text = `âœ… SKUëª…: ${data.sku}\n`;
            text += data.matches.map(match =>
              `ğŸ“ ${match.center} ì„¼í„°\nğŸ“… ì…ê³  ì˜ˆì •ì¼: ${match.date}\nğŸ“¦ ë‚©í’ˆìˆ˜ëŸ‰: ${match.qty}ê°œ\n`
            ).join("\n");

            resultDiv.innerText = text;

            // ì²« ë²ˆì§¸ í•­ëª©ë§Œ ìŒì„±ìœ¼ë¡œ ì•ˆë‚´
            const first = data.matches[0];
            speak(`${first.center} ì„¼í„°, ì…ê³  ì˜ˆì •ì¼ ${first.date}, ë‚©í’ˆìˆ˜ëŸ‰ ${first.qty}ê°œ, ìƒí’ˆ: ${data.sku}`);
          } else {
            resultDiv.innerText = "âŒ ë°”ì½”ë“œ ì—†ìŒ";
            speak("í•´ë‹¹ ë°”ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
          }
        })
        .catch((err) => {
          document.getElementById("result").innerText = "âŒ ìš”ì²­ ì˜¤ë¥˜";
          speak("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
        });
    }

    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            handleScannedBarcode(decodedText);
          },
          (errorMessage) => {
            // ì—ëŸ¬ ë¬´ì‹œ
          }
        );
      }
    }).catch(err => {
      document.getElementById("result").innerText = "ğŸ“· ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨";
    });
  </script>
</body>
</html>
