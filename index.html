<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ì…ê³  ìŠ¤ìºë„ˆ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
      body { font-family: sans-serif; text-align: center; padding: 1rem; }
      #reader { width: 100%; max-width: 400px; margin: auto; }
      #result { margin-top: 1rem; font-size: 1.1rem; white-space: pre-line; }
    </style>
  </head>
  <body>
    <h2>ğŸ“¦ ì…ê³  ìŠ¤ìºë„ˆ</h2>
    <div id="reader"></div>
    <div id="result">ìŠ¤ìº” ëŒ€ê¸° ì¤‘...</div>

    <script>
      let speakCount = 0;
      let lastSpokenText = "";

      function speak(text) {
        if (text === lastSpokenText && speakCount >= 2) return;
        if (text !== lastSpokenText) {
          lastSpokenText = text;
          speakCount = 0;
        }
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ko-KR';
        msg.onend = () => speakCount++;
        speechSynthesis.speak(msg);
      }

      function handleBarcode(barcode) {
        fetch(`https://script.google.com/macros/s/AKfycby-FnENdO0xe3Sp9JtguVgchmvsnSmBe97rVe49QWildLiQ_APmmH4qEqHTgn0IqJmi/exec?barcode=${barcode}`)
          .then(res => res.json())
          .then(data => {
            const resultDiv = document.getElementById("result");
            if (data.found) {
              const message = `âœ… ${data.center} ì„¼í„°\nì…ê³  ì˜ˆì •ì¼: ${data.date}\nSKUëª…: ${data.sku}\në‚©í’ˆìˆ˜ëŸ‰: ${data.deliveryQty}ê°œ`;
              resultDiv.innerText = message;
              speak(`${data.center} ì„¼í„°, ì…ê³  ì˜ˆì •ì¼ ${data.date}, SKU ${data.sku}, ë‚©í’ˆìˆ˜ëŸ‰ ${data.deliveryQty}ê°œ`);
            } else {
              resultDiv.innerText = "âŒ ë°”ì½”ë“œ ì—†ìŒ";
              speak("í•´ë‹¹ ë°”ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
            }
          });
      }

      const html5QrCode = new Html5Qrcode("reader");
      const config = { fps: 10, qrbox: 250 };

      Html5Qrcode.getCameras().then(devices => {
        const backCamera = devices.find(d => d.label.toLowerCase().includes('back')) || devices[0];
        html5QrCode.start(
          { deviceId: { exact: backCamera.id } },
          config,
          (decodedText) => {
            handleBarcode(decodedText);
          }
        );
      }).catch(err => {
        document.getElementById("result").innerText = `âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ${err}`;
      });
    </script>
  </body>
</html>
