<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>입고 스캐너</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
      body { font-family: sans-serif; text-align: center; padding: 1rem; }
      #reader { width: 100%; max-width: 400px; margin: auto; }
      #result { margin-top: 1rem; font-size: 1.1rem; white-space: pre-line; }
    </style>
  </head>
  <body>
    <h2>📦 입고 스캐너</h2>
    <div id="reader"></div>
    <div id="result">스캔 대기 중...</div>

    <script>
      let speakCount = 0;
      let lastSpokenText = "";

      function speak(text) {
        if (text === lastSpokenText && speakCount >= 2) return;
        if (text !== lastSpokenText) {
          lastSpokenText = text;
          speakCount = 0;
        }
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ko-KR';
        msg.onend = () => speakCount++;
        speechSynthesis.speak(msg);
      }

      function handleBarcode(barcode) {
        fetch(`https://script.google.com/macros/s/AKfycby-FnENdO0xe3Sp9JtguVgchmvsnSmBe97rVe49QWildLiQ_APmmH4qEqHTgn0IqJmi/exec?barcode=${barcode}`)
          .then(res => res.json())
          .then(data => {
            const resultDiv = document.getElementById("result");
            if (data.found) {
              const message = `✅ ${data.center} 센터\n입고 예정일: ${data.date}\nSKU명: ${data.sku}\n납품수량: ${data.deliveryQty}개`;
              resultDiv.innerText = message;
              speak(`${data.center} 센터, 입고 예정일 ${data.date}, SKU ${data.sku}, 납품수량 ${data.deliveryQty}개`);
            } else {
              resultDiv.innerText = "❌ 바코드 없음";
              speak("해당 바코드를 찾을 수 없습니다");
            }
          });
      }

      const html5QrCode = new Html5Qrcode("reader");
      const config = { fps: 10, qrbox: 250 };

      Html5Qrcode.getCameras().then(devices => {
        const backCamera = devices.find(d => d.label.toLowerCase().includes('back')) || devices[0];
        html5QrCode.start(
          { deviceId: { exact: backCamera.id } },
          config,
          (decodedText) => {
            handleBarcode(decodedText);
          }
        );
      }).catch(err => {
        document.getElementById("result").innerText = `❌ 카메라 접근 오류: ${err}`;
      });
    </script>
  </body>
</html>
